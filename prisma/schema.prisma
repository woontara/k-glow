// Prisma Schema for K-Glow Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 사용자
model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  name                   String
  emailVerified          DateTime?
  image                  String?
  password               String?
  role                   UserRole                @default(BRAND)
  companyName            String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  // 브랜드 연결 (BRAND 역할 사용자용)
  brandId                String?
  brand                  Brand?                  @relation(fields: [brandId], references: [id])

  // 크레딧/결제 관련
  creditBalance          Float                   @default(0)    // 현재 잔액 (USD)
  billingKey             String?                 @unique        // PortOne 빌링키

  // 자동 충전 설정
  autoRecharge           Boolean                 @default(false)  // 자동 충전 활성화
  rechargeThreshold      Float                   @default(2)      // 충전 임계값 (USD)
  rechargeAmount         Float                   @default(15)     // 충전 금액 (USD)

  certificationRequests  CertificationRequest[]
  quotes                 Quote[]
  accounts               Account[]
  sessions               Session[]
  uploadedProducts       UploadedProduct[]
  aiUsageLogs            AiUsageLog[]
  workLibraryItems       WorkLibraryItem[]
  payments               Payment[]
  creditLogs             CreditLog[]

  @@index([brandId])
  @@index([billingKey])
  @@map("users")
}

// 브랜드 (한국 브랜드 고객사 - 마켓플레이스 SKU 필터링용)
model Brand {
  id                     String                  @id @default(cuid())
  name                   String                  // 브랜드명 (영문)
  nameKo                 String                  // 브랜드명 (한글)
  skuPrefix              String                  @unique // SKU 접두사 (예: "BRAND1", "ABC")
  description            String?                 // 브랜드 설명
  logoUrl                String?                 // 로고 URL
  websiteUrl             String?                 // 웹사이트 URL
  contactEmail           String?                 // 담당자 이메일
  contactPhone           String?                 // 담당자 연락처
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  users                  User[]                  // 이 브랜드에 속한 사용자들

  @@index([skuPrefix])
  @@index([isActive])
  @@map("brands")
}

enum UserRole {
  BRAND
  BUYER
  ADMIN
}

// 파트너사 (한국 브랜드)
model Partner {
  id                     String                  @id @default(cuid())
  name                   String
  nameRu                 String
  websiteUrl             String
  logoUrl                String?
  description            String
  descriptionRu          String
  marketScore            Int                     @default(0)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  products               Product[]
  certificationRequests  CertificationRequest[]

  @@map("partners")
}

// 제품
model Product {
  id                     String                  @id @default(cuid())
  partnerId              String
  partner                Partner                 @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  name                   String
  nameRu                 String
  category               String
  price                  Float
  priceRub               Float
  ingredients            Json                    // String[]
  ingredientsRu          Json                    // String[]
  description            String
  descriptionRu          String
  imageUrls              Json                    // String[]

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  @@index([partnerId])
  @@map("products")
}

// 인증 신청
model CertificationRequest {
  id                     String                  @id @default(cuid())
  userId                 String
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  partnerId              String
  partner                Partner                 @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  certType               CertificationType
  status                 CertificationStatus     @default(PENDING)
  documents              Json                    // String[]
  estimatedCost          Float
  notes                  String?

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  @@index([userId])
  @@index([partnerId])
  @@index([status])
  @@map("certification_requests")
}

enum CertificationType {
  EAC
  GOST
  OTHER
}

enum CertificationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

// 견적
model Quote {
  id                     String                  @id @default(cuid())
  userId                 String
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  products               Json                    // QuoteProduct[]
  totalKrw               Float
  totalRub               Float
  shippingCost           Float
  certificationCost      Float
  exchangeRate           Float

  createdAt              DateTime                @default(now())

  @@index([userId])
  @@map("quotes")
}

// 상품 상세페이지 리빌드
model ProductRebuild {
  id                String   @id @default(cuid())
  sourceUrl         String
  sourceSite        String   // coupang, naver, 11st, generic

  // 한국어 원본
  name              String
  price             Float?
  priceOriginal     String?
  description       String

  // 러시아어 번역
  nameRu            String
  descriptionRu     String

  // 성분
  ingredients       Json     // String[]
  ingredientsRu     Json     // String[]

  // 이미지
  screenshotUrl     String?
  imageUrls         Json     // String[] - 다운로드된 로컬 경로
  originalImageUrls Json     // String[] - 원본 URL

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([sourceUrl])
  @@index([sourceSite])
  @@map("product_rebuilds")
}

// 업로드된 상품 (cafe24 양식)
model UploadedProduct {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productCode       String?  // 상품코드
  customCode        String?  // 자체 상품코드
  displayStatus     Boolean  @default(true)  // 진열상태
  saleStatus        Boolean  @default(true)  // 판매상태
  name              String   // 상품명
  nameEn            String?  // 영문 상품명
  price             Int      @default(0)     // 판매가
  supplyPrice       Int?     // 공급가
  retailPrice       Int?     // 소비자가
  manufacturer      String?  // 제조사
  brand             String?  // 브랜드
  origin            String?  // 원산지
  description       String?  // 상품 상세설명
  shortDescription  String?  // 상품 간략설명
  rawData           Json     // 원본 CSV 데이터 전체

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([brand])
  @@map("uploaded_products")
}

// 문의하기
model ContactInquiry {
  id        String        @id @default(cuid())
  name      String        // 담당자명
  company   String        // 회사명
  email     String        // 이메일
  phone     String?       // 연락처
  service   String        // 관심 서비스
  message   String        // 문의 내용
  status    InquiryStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([status])
  @@index([email])
  @@map("contact_inquiries")
}

enum InquiryStatus {
  PENDING     // 대기중
  IN_PROGRESS // 처리중
  COMPLETED   // 완료
}

// 포트폴리오 (성공 사례)
model Portfolio {
  id              String            @id @default(cuid())

  // 브랜드 정보
  brand           String            // 브랜드명
  brandLogoUrl    String?           // 브랜드 로고 URL
  brandWebsite    String?           // 브랜드 웹사이트
  category        PortfolioCategory // 제품 카테고리

  // 프로젝트 정보
  title           String            // 핵심 성과 한줄 (예: "Wildberries 입점 3개월 만에 월 매출 5억 달성")
  marketplaces    Json              // 입점 마켓플레이스 (예: ["Wildberries", "Ozon"])
  services        Json              // 제공 서비스 (예: ["EAC 인증", "입점 대행", "마케팅"])
  projectYear     String?           // 프로젝트 연도 (예: "2024")
  duration        String?           // 소요 기간 (예: "3개월")

  // 성과 지표
  monthlySales    String?           // 월 매출 (예: "5억+")
  productCount    String?           // 입점 상품 수 (예: "12종")
  rating          String?           // 마켓플레이스 평점 (예: "4.8")
  achievement     String?           // 주요 성과 (예: "뷰티 카테고리 TOP 10 진입")

  // 스토리
  challenge       String?           // 고객의 도전 과제/니즈
  solution        String?           // K-Glow의 솔루션
  results         String?           // 결과/성과 상세 설명

  // 표시 설정
  imageUrl        String            // 대표 이미지 URL
  gradient        String            @default("from-[#8BA4B4] to-[#6B8A9A]")
  isActive        Boolean           @default(true)
  isFeatured      Boolean           @default(false) // 메인 페이지 노출 여부
  order           Int               @default(0)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([isFeatured])
  @@map("portfolios")
}

enum PortfolioCategory {
  SKINCARE
  MAKEUP
  HAIRCARE
  BODYCARE
  OTHER
}

// 고객 후기
model Testimonial {
  id        String   @id @default(cuid())
  name      String   // 고객명
  company   String   // 회사명
  content   String   // 후기 내용
  gradient  String   @default("from-[#8BA4B4] to-[#6B8A9A]")
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@map("testimonials")
}

// NextAuth.js 모델
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// AI 모델 (fal.ai 연동)
model AiModel {
  id            String          @id @default(cuid())
  name          String          // 모델명 (한글)
  nameEn        String          // 모델명 (영문)
  modelId       String          @unique // fal.ai 모델 ID (예: "fal-ai/birefnet")
  category      AiModelCategory
  description   String?         // 모델 설명
  iconUrl       String?         // 아이콘 URL
  apiKey        String?         // 모델별 API 키 (fal.ai)
  defaultParams Json?           // 기본 파라미터 (JSON)
  pricePerUse   Float           @default(0) // 1회 사용 비용 (USD)
  isActive      Boolean         @default(true)
  order         Int             @default(0) // 표시 순서
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  usageLogs     AiUsageLog[]

  @@index([category])
  @@index([isActive])
  @@map("ai_models")
}

enum AiModelCategory {
  IMAGE_GENERATION    // 이미지 생성
  BACKGROUND_REMOVAL  // 배경 제거
  UPSCALING           // 업스케일링
  VIDEO_GENERATION    // 비디오 생성
  TEXT_TO_SPEECH      // 텍스트 음성 변환
}

// AI 사용 기록
model AiUsageLog {
  id           String        @id @default(cuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  modelId      String
  model        AiModel       @relation(fields: [modelId], references: [id], onDelete: Cascade)

  inputParams  Json          // 입력 파라미터
  outputUrl    String?       // 결과 URL
  status       AiUsageStatus @default(PENDING)
  errorMessage String?       // 에러 메시지

  createdAt    DateTime      @default(now())
  completedAt  DateTime?

  @@index([userId])
  @@index([modelId])
  @@index([status])
  @@map("ai_usage_logs")
}

enum AiUsageStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// 작업물 라이브러리 (사용자가 저장한 AI 생성물)
model WorkLibraryItem {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String       // 사용자가 지정한 이름
  type        WorkItemType // AUDIO, IMAGE, VIDEO
  url         String       // 파일 URL
  thumbnail   String?      // 썸네일 URL (이미지/비디오용)
  metadata    Json?        // 추가 정보 (duration, fileSize 등)

  sourceLogId String?      // 원본 AiUsageLog 참조 (선택)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userId])
  @@index([type])
  @@map("work_library_items")
}

enum WorkItemType {
  AUDIO
  IMAGE
  VIDEO
  TEXT
  FILE
}

// 결제 기록
model Payment {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount          Float                           // 결제 금액 (USD)
  currency        String        @default("USD")
  status          PaymentStatus @default(PENDING)

  portonePaymentId String?       @unique           // PortOne 결제 ID
  description     String?

  createdAt       DateTime      @default(now())
  completedAt     DateTime?

  creditLogs      CreditLog[]

  @@index([userId])
  @@index([status])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// 크레딧 사용/충전 기록
model CreditLog {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount       Float                              // + 충전, - 사용
  type         CreditLogType
  description  String?

  // AI 사용 시 참조
  aiUsageLogId String?        @unique

  // 결제 시 참조
  paymentId    String?
  payment      Payment?       @relation(fields: [paymentId], references: [id])

  balanceAfter Float                              // 변동 후 잔액
  createdAt    DateTime       @default(now())

  @@index([userId])
  @@index([type])
  @@index([paymentId])
  @@map("credit_logs")
}

enum CreditLogType {
  CHARGE          // 충전
  AUTO_CHARGE     // 자동 충전
  USAGE           // AI 도구 사용
  REFUND          // 환불
  ADMIN_ADJUST    // 관리자 조정
}

// 공급업체 (한국 화장품 공급업체)
model Supplier {
  id          String            @id @default(cuid())
  name        String            @unique  // 공급업체명 (예: TIRTIR, BEPLAIN, ABIB)
  contactName String?           // 담당자명
  contactEmail String?          // 담당자 이메일
  contactPhone String?          // 담당자 연락처
  website     String?           // 웹사이트
  notes       String?           // 메모
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  products    SupplierProduct[]

  @@index([isActive])
  @@map("suppliers")
}

// 공급업체 제품 (가격표 데이터)
model SupplierProduct {
  id           String   @id @default(cuid())
  supplierId   String
  supplier     Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  // 핵심 공통 필드
  barcode      String?  // 바코드 (모든 업체 공통)
  nameKr       String   // 한글 제품명 (모든 업체 공통)
  nameEn       String?  // 영문 제품명 (모든 업체 공통)
  msrp         Float?   // 권장소비자가 (모든 업체 공통)
  supplyPrice  Float?   // 공급가 (모든 업체 공통)

  // 선택적 필드 (일부 업체만)
  productCode  String?  // 제품코드 (BEPLAIN)
  volume       String?  // 용량 (ABIB)
  shelfLife    String?  // 유통기한 (BEPLAIN, ABIB)
  boxQty       Int?     // 박스당 수량
  imageUrl     String?  // 제품 이미지 URL

  // 원본 데이터 (업체별 모든 컬럼 저장)
  rawData      Json     // 원본 엑셀 행 데이터 전체

  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([supplierId])
  @@index([nameKr])
  @@index([barcode])
  @@index([isActive])
  @@map("supplier_products")
}
